trigger:
  branches:
    include:
      - main
      - mobile-friendly

pr: none

variables:
  nodeVersion: "24.x"

stages:
  - stage: Build
    displayName: "Build"
    pool:
      vmImage: "ubuntu-latest"
    jobs:
      - job: Build
        displayName: "Build Standalone App"
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "$(nodeVersion)"
            displayName: "Install Node.js $(nodeVersion)"

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              path: "$(HOME)/.npm"
            displayName: "Cache npm packages"

          - script: npm ci
            displayName: "Install dependencies"

          - script: rm -rf .next
            displayName: "Clean previous build artifacts"

          - script: npm run build
            displayName: "Build standalone app"
            env:
              NEXT_PUBLIC_GOOGLE_CLIENT_ID: $(NEXT_PUBLIC_GOOGLE_CLIENT_ID)
              DB_SERVER: $(DB_SERVER)
              DB_DATABASE: $(DB_DATABASE)
              DB_USER: $(DB_USER)
              DB_PASSWORD: $(DB_PASSWORD)

          - script: |
              cp -r public .next/standalone/public
              cp -r .next/static .next/standalone/.next/static
              if [ -d content ] && [ "$(ls -A content)" ]; then
                cp -r content .next/standalone/content
              fi
            displayName: "Copy static assets and content into standalone"

          - task: ArchiveFiles@2
            displayName: "Archive standalone app"
            inputs:
              rootFolderOrFile: ".next/standalone"
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/standalone-app.zip"

          - task: PublishPipelineArtifact@1
            displayName: "Publish standalone artifact"
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)/standalone-app.zip"
              artifactName: "standalone-app"

  - stage: Deploy
    displayName: "Deploy"
    dependsOn: Build
    condition: succeeded()
    pool:
      vmImage: "ubuntu-latest"
    jobs:
      - deployment: DeployWeb
        displayName: "Deploy to Azure Web App"
        environment: "Development"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: "Download standalone artifact"
                  inputs:
                    artifactName: "standalone-app"
                    targetPath: "$(Pipeline.Workspace)"

                - task: AzureWebApp@1
                  displayName: "Deploy to Azure Web App"
                  inputs:
                    azureSubscription: "Pay-As-You-Go - SSI (ee9f0e11-43bd-4668-8728-b0ce2d0bee8a)"
                    appType: "webAppLinux"
                    appName: "LearnToPlay"
                    package: "$(Pipeline.Workspace)/standalone-app.zip"
                    startUpCommand: "node server.js"
