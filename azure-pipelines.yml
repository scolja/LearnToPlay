trigger:
  branches:
    include:
      - main

variables:
  nodeVersion: "24.x"

stages:
  - stage: Build
    displayName: "Build"
    pool:
      vmImage: "ubuntu-latest"
    jobs:
      - job: Build
        displayName: "Build Static Site"
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "$(nodeVersion)"
            displayName: "Install Node.js $(nodeVersion)"

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              path: "$(Pipeline.Workspace)/.npm"
            displayName: "Cache npm packages"

          - task: Cache@2
            inputs:
              key: 'nextjs | "$(Agent.OS)" | package-lock.json'
              path: ".next/cache"
            displayName: "Cache Next.js build"

          - script: npm ci
            displayName: "Install dependencies"

          - script: npm run build
            displayName: "Build static site"

          - task: ArchiveFiles@2
            displayName: "Archive static site"
            inputs:
              rootFolderOrFile: "out"
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/static-site.zip"

          - task: PublishPipelineArtifact@1
            displayName: "Publish static site artifact"
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)/static-site.zip"
              artifactName: "static-site"

  - stage: Deploy
    displayName: "Deploy"
    dependsOn: Build
    condition: succeeded()
    pool:
      vmImage: "ubuntu-latest"
    jobs:
      - deployment: DeployWeb
        displayName: "Deploy to Azure Web App"
        environment: "production"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  displayName: "Download static site artifact"
                  inputs:
                    artifactName: "static-site"
                    targetPath: "$(Pipeline.Workspace)"

                - task: AzureWebApp@1
                  displayName: "Deploy to Azure Web App"
                  inputs:
                    azureSubscription: "Pay-As-You-Go - SSI (ee9f0e11-43bd-4668-8728-b0ce2d0bee8a)"
                    appType: "webAppLinux"
                    appName: "LearnToPlay"
                    package: "$(Pipeline.Workspace)/static-site.zip"
